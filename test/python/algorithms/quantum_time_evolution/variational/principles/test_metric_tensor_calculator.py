# This code is part of Qiskit.
#
# (C) Copyright IBM 2021.
#
# This code is licensed under the Apache License, Version 2.0. You may
# obtain a copy of this license in the LICENSE.txt file in the root directory
# of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.
#
# Any modifications or derivative works of this code must retain this
# copyright notice, and modified files need to carry a notice indicating
# that they have been altered from the originals.
import unittest

import numpy as np

from qiskit.algorithms.quantum_time_evolution.variational.principles.metric_tensor_calculator import (
    build,
)
from qiskit.circuit.library import EfficientSU2
from qiskit.opflow import SummedOp, X, Y, I, Z, Gradient
from test.python.algorithms import QiskitAlgorithmsTestCase


class TestMetricTensorBuilder(QiskitAlgorithmsTestCase):
    def test_build(self):

        observable = SummedOp(
            [
                0.2252 * (I ^ I),
                0.5716 * (Z ^ Z),
                0.3435 * (I ^ Z),
                -0.4347 * (Z ^ I),
                0.091 * (Y ^ Y),
                0.091 * (X ^ X),
            ]
        ).reduce()

        d = 2
        ansatz = EfficientSU2(observable.num_qubits, reps=d)

        # Define a set of initial parameters
        parameters = ansatz.ordered_parameters
        metric_tensor = build(observable, ansatz, parameters)

        values_dict = [
            {param: np.pi / 4 for param in parameters},
            {param: np.pi / 2 for param in parameters},
        ]
        # TODO extract
        correct_values = [
            [
                [
                    1.00000000e00 + 0.0j,
                    0.00000000e00 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    3.53553391e-01 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    -5.66941738e-01 + 0.0j,
                    1.25000000e-01 + 0.0j,
                    4.00888348e-01 + 0.0j,
                    -1.25000000e-01 + 0.0j,
                ],
                [
                    0.00000000e00 + 0.0j,
                    1.00000000e00 + 0.0j,
                    0.00000000e00 + 0.0j,
                    -2.80000000e-17 + 0.0j,
                    -3.53553391e-01 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    -3.38388348e-01 + 0.0j,
                    3.01776695e-01 + 0.0j,
                    5.92830086e-01 + 0.0j,
                    8.01776695e-01 + 0.0j,
                ],
                [
                    8.30000000e-17 + 0.0j,
                    0.00000000e00 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    0.00000000e00 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    4.78553391e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    -2.05805826e-01 + 0.0j,
                    2.75888348e-01 + 0.0j,
                    4.19733047e-02 + 0.0j,
                    -2.75888348e-01 + 0.0j,
                ],
                [
                    5.60000000e-17 + 0.0j,
                    -2.80000000e-17 + 0.0j,
                    0.00000000e00 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    -2.50000000e-01 + 0.0j,
                    1.25000000e-01 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    2.05805826e-01 + 0.0j,
                    -2.75888348e-01 + 0.0j,
                    3.12500000e-02 + 0.0j,
                    7.76650429e-02 + 0.0j,
                ],
                [
                    3.53553391e-01 + 0.0j,
                    -3.53553391e-01 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    9.37500000e-01 + 0.0j,
                    -4.41941738e-01 + 0.0j,
                    -8.08058262e-02 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    5.98191738e-02 + 0.0j,
                    -8.99587393e-02 + 0.0j,
                    -5.68689110e-03 + 0.0j,
                    -4.95288825e-01 + 0.0j,
                ],
                [
                    8.30000000e-17 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    -2.50000000e-01 + 0.0j,
                    -4.41941738e-01 + 0.0j,
                    8.75000000e-01 + 0.0j,
                    -1.07233047e-02 + 0.0j,
                    1.97989899e-17 + 0.0j,
                    -6.28791261e-01 + 0.0j,
                    1.01332521e-01 + 0.0j,
                    3.92924785e-02 + 0.0j,
                    4.24555826e-01 + 0.0j,
                ],
                [
                    2.50000000e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    4.78553391e-01 + 0.0j,
                    1.25000000e-01 + 0.0j,
                    -8.08058262e-02 + 0.0j,
                    -1.07233047e-02 + 0.0j,
                    8.95526695e-01 + 0.0j,
                    5.51776695e-01 + 0.0j,
                    -1.51213586e-01 + 0.0j,
                    6.33692956e-01 + 0.0j,
                    5.38142586e-01 + 0.0j,
                    -2.19860435e-01 + 0.0j,
                ],
                [
                    5.60000000e-17 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    2.50000000e-01 + 0.0j,
                    5.00000000e-01 + 0.0j,
                    -1.76776695e-01 + 0.0j,
                    1.97989899e-17 + 0.0j,
                    5.51776695e-01 + 0.0j,
                    1.00000000e00 + 0.0j,
                    2.61984848e-17 + 0.0j,
                    1.31150758e-16 + 0.0j,
                    3.90165043e-01 + 0.0j,
                    2.28553391e-01 + 0.0j,
                ],
                [
                    -5.66941738e-01 + 0.0j,
                    -3.38388348e-01 + 0.0j,
                    -2.05805826e-01 + 0.0j,
                    2.05805826e-01 + 0.0j,
                    5.98191738e-02 + 0.0j,
                    -6.28791261e-01 + 0.0j,
                    -1.51213586e-01 + 0.0j,
                    2.61984848e-17 + 0.0j,
                    7.81135011e-01 + 0.0j,
                    -1.53176576e-01 + 0.0j,
                    -2.44557038e-01 + 0.0j,
                    -1.80635315e-01 + 0.0j,
                ],
                [
                    1.25000000e-01 + 0.0j,
                    3.01776695e-01 + 0.0j,
                    2.75888348e-01 + 0.0j,
                    -2.75888348e-01 + 0.0j,
                    -8.99587393e-02 + 0.0j,
                    1.01332521e-01 + 0.0j,
                    6.33692956e-01 + 0.0j,
                    1.31150758e-16 + 0.0j,
                    -1.53176576e-01 + 0.0j,
                    8.70518804e-01 + 0.0j,
                    5.29727238e-01 + 0.0j,
                    -7.67845869e-02 + 0.0j,
                ],
                [
                    4.00888348e-01 + 0.0j,
                    5.92830086e-01 + 0.0j,
                    4.19733047e-02 + 0.0j,
                    3.12500000e-02 + 0.0j,
                    -5.68689110e-03 + 0.0j,
                    3.92924785e-02 + 0.0j,
                    5.38142586e-01 + 0.0j,
                    3.90165043e-01 + 0.0j,
                    -2.44557038e-01 + 0.0j,
                    5.29727238e-01 + 0.0j,
                    7.26734984e-01 + 0.0j,
                    2.91560978e-01 + 0.0j,
                ],
                [
                    -1.25000000e-01 + 0.0j,
                    8.01776695e-01 + 0.0j,
                    -2.75888348e-01 + 0.0j,
                    7.76650429e-02 + 0.0j,
                    -4.95288825e-01 + 0.0j,
                    4.24555826e-01 + 0.0j,
                    -2.19860435e-01 + 0.0j,
                    2.28553391e-01 + 0.0j,
                    -1.80635315e-01 + 0.0j,
                    -7.67845869e-02 + 0.0j,
                    2.91560978e-01 + 0.0j,
                    9.54465413e-01 + 0.0j,
                ],
            ],
            [
                [
                    1.00000000e00 + 0.0j,
                    0.00000000e00 + 0.0j,
                    1.67000000e-16 + 0.0j,
                    0.00000000e00 + 0.0j,
                    0.00000000e00 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    1.67000000e-16 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    0.00000000e00 + 0.0j,
                    3.33000000e-16 + 0.0j,
                    -1.67000000e-16 + 0.0j,
                    -2.80000000e-17 + 0.0j,
                ],
                [
                    0.00000000e00 + 0.0j,
                    1.00000000e00 + 0.0j,
                    0.00000000e00 + 0.0j,
                    2.50000000e-16 + 0.0j,
                    -1.00000000e00 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    4.20000000e-17 + 0.0j,
                    -2.80000000e-17 + 0.0j,
                    2.80000000e-17 + 0.0j,
                ],
                [
                    1.67000000e-16 + 0.0j,
                    0.00000000e00 + 0.0j,
                    1.00000000e00 + 0.0j,
                    -2.64320000e-32 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    -3.05000000e-16 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                ],
                [
                    0.00000000e00 + 0.0j,
                    2.50000000e-16 + 0.0j,
                    -2.64320000e-32 + 0.0j,
                    1.00000000e00 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.67000000e-16 + 0.0j,
                    2.50000000e-16 + 0.0j,
                    2.78000000e-16 + 0.0j,
                    9.80000000e-17 + 0.0j,
                    -2.23000000e-16 + 0.0j,
                    1.53000000e-16 + 0.0j,
                    -8.30000000e-17 + 0.0j,
                ],
                [
                    0.00000000e00 + 0.0j,
                    -1.00000000e00 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    -1.94000000e-16 + 0.0j,
                    -1.00000000e00 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    -1.11000000e-16 + 0.0j,
                    1.11000000e-16 + 0.0j,
                ],
                [
                    5.60000000e-17 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    1.67000000e-16 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                    -4.20000000e-17 + 0.0j,
                    -2.52000000e-33 + 0.0j,
                    -2.90000000e-17 + 0.0j,
                    -1.66000000e-16 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                ],
                [
                    1.67000000e-16 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    8.30000000e-17 + 0.0j,
                    2.50000000e-16 + 0.0j,
                    -1.94000000e-16 + 0.0j,
                    -4.20000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    1.94000000e-16 + 0.0j,
                    1.56800000e-33 + 0.0j,
                    6.90000000e-17 + 0.0j,
                    2.08000000e-16 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                ],
                [
                    -5.60000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    2.78000000e-16 + 0.0j,
                    -1.00000000e00 + 0.0j,
                    -2.52000000e-33 + 0.0j,
                    1.94000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                    7.00000000e-17 + 0.0j,
                    -8.30000000e-17 + 0.0j,
                    1.39000000e-16 + 0.0j,
                    1.11000000e-16 + 0.0j,
                ],
                [
                    0.00000000e00 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    9.80000000e-17 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    -2.90000000e-17 + 0.0j,
                    1.56800000e-33 + 0.0j,
                    7.00000000e-17 + 0.0j,
                    1.11022302e-16 + 0.0j,
                    -5.55111512e-16 + 0.0j,
                    1.10000000e-16 + 0.0j,
                    -1.61000000e-16 + 0.0j,
                ],
                [
                    3.33000000e-16 + 0.0j,
                    4.20000000e-17 + 0.0j,
                    -3.05000000e-16 + 0.0j,
                    -2.23000000e-16 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    -1.66000000e-16 + 0.0j,
                    6.90000000e-17 + 0.0j,
                    -8.30000000e-17 + 0.0j,
                    -5.55111512e-16 + 0.0j,
                    4.44089210e-16 + 0.0j,
                    -1.10000000e-16 + 0.0j,
                    -1.03000000e-16 + 0.0j,
                ],
                [
                    -1.67000000e-16 + 0.0j,
                    -2.80000000e-17 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.53000000e-16 + 0.0j,
                    -1.11000000e-16 + 0.0j,
                    5.60000000e-17 + 0.0j,
                    2.08000000e-16 + 0.0j,
                    1.39000000e-16 + 0.0j,
                    1.10000000e-16 + 0.0j,
                    -1.10000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                    1.80000000e-16 + 0.0j,
                ],
                [
                    -2.80000000e-17 + 0.0j,
                    2.80000000e-17 + 0.0j,
                    1.00000000e00 + 0.0j,
                    -8.30000000e-17 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                    -5.60000000e-17 + 0.0j,
                    1.11000000e-16 + 0.0j,
                    -1.61000000e-16 + 0.0j,
                    -1.03000000e-16 + 0.0j,
                    1.80000000e-16 + 0.0j,
                    1.00000000e00 + 0.0j,
                ],
            ],
        ]

        for i, value_dict in enumerate(values_dict):
            np.testing.assert_array_almost_equal(
                metric_tensor.assign_parameters(value_dict).eval(), correct_values[i], decimal=1
            )


if __name__ == "__main__":
    unittest.main()
